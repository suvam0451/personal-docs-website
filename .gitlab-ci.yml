image: node:latest

stages:
    - assembly
    - build
    - test
    - publish

cache: &global_cache
    key: ${CI_COMMIT_REF_SLUG}
    paths:
        - node_modules/
    policy: pull-push

SleepingForest:
    image: golang:latest
    stage: assembly
    script:
        - cd ..
        - git clone https://suvam0451:$GITLAB_AUTH_TOKEN@gitlab.com/suvam0451/sleeping-forest-ue4.git
        - cp -r sleeping-forest-ue4/snippets sleeping-forest-ue4/devops
        # now we are outside  both projects
        - mkdir -p sleeping-forest-ue4/devops/content/sleeping-forest/02-Snippets/02-Full-list
        - mkdir -p sleeping-forest-ue4/devops/intermediate
        - cd sleeping-forest-ue4/devops
        - go run entry.go
        - cd ../../
        - cp -r sleeping-forest-ue4/devops/content netlify-ci-test
    artifacts:
        paths:
            - ./content/*

GatsbyBuild:
    image: node:latest
    stage: build
    cache:
        <<: *global_cache
    script:
        - yarn install --silent
        - yarn gatsby build
    dependencies:
        - SleepingForest

# Default behavior is a dummy deploy
NetlifyDeploy:
    image: node:latest
    stage: publish
    script:
        - npm i netlify-cli -g
        - netlify deploy --auth $NETLIFY_AUTH_TOKEN --site $NETLIFY_SITE_ID
    dependencies:
        - GatsbyBuild

# Deploy changes to website if -publish is passed in commit
NetlifyPublish:
    image: node:latest
    stage: publish
    script:
        - npm i netlify-cli -g
        - netlify deploy --auth $NETLIFY_AUTH_TOKEN --site $NETLIFY_SITE_ID
    dependencies:
        - GatsbyBuild
    only:
        variables:
          - $CI_COMMIT_MESSAGE =~ /-publish/